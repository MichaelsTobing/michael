From 6e792943c87d1d16815c9b0b9718f138a04897a2 Mon Sep 17 00:00:00 2001
From: root <root@mgt-development-environment-72>
Date: Tue, 15 Dec 2020 02:41:33 +0000
Subject: [PATCH] lazy loading + webp patch

---
 .../Block/Product/ImageFactory.php            | 297 ++++++++++++++++++
 app/code/Icube/LazyLoading/Helper/Data.php    |  71 +++++
 .../Icube/LazyLoading/etc/frontend/di.xml     |   5 +
 app/code/Icube/LazyLoading/etc/module.xml     |  15 +
 app/code/Icube/LazyLoading/registration.php   |   7 +
 .../frontend/templates/product/image.phtml    |  76 +++++
 .../product/image_with_borders.phtml          |  81 +++++
 .../LazyLoadingWebp/Block/Product/Image.php   |  46 +++
 .../Icube/LazyLoadingWebp/etc/frontend/di.xml |   4 +
 app/code/Icube/LazyLoadingWebp/etc/module.xml |   8 +
 .../Icube/LazyLoadingWebp/registration.php    |   7 +
 .../templates/category/lazyload_custom.phtml  |  93 ++++++
 12 files changed, 710 insertions(+)
 create mode 100644 app/code/Icube/LazyLoading/Block/Product/ImageFactory.php
 create mode 100644 app/code/Icube/LazyLoading/Helper/Data.php
 create mode 100644 app/code/Icube/LazyLoading/etc/frontend/di.xml
 create mode 100644 app/code/Icube/LazyLoading/etc/module.xml
 create mode 100644 app/code/Icube/LazyLoading/registration.php
 create mode 100644 app/code/Icube/LazyLoading/view/frontend/templates/product/image.phtml
 create mode 100644 app/code/Icube/LazyLoading/view/frontend/templates/product/image_with_borders.phtml
 create mode 100644 app/code/Icube/LazyLoadingWebp/Block/Product/Image.php
 create mode 100644 app/code/Icube/LazyLoadingWebp/etc/frontend/di.xml
 create mode 100644 app/code/Icube/LazyLoadingWebp/etc/module.xml
 create mode 100644 app/code/Icube/LazyLoadingWebp/registration.php
 create mode 100644 app/code/Icube/LazyLoadingWebp/view/frontend/templates/category/lazyload_custom.phtml

diff --git a/app/code/Icube/LazyLoading/Block/Product/ImageFactory.php b/app/code/Icube/LazyLoading/Block/Product/ImageFactory.php
new file mode 100644
index 000000000..7d30580bc
--- /dev/null
+++ b/app/code/Icube/LazyLoading/Block/Product/ImageFactory.php
@@ -0,0 +1,297 @@
+<?php
+
+namespace Icube\LazyLoading\Block\Product;
+
+use Magento\Catalog\Block\Product\Image as ImageBlock;
+use Magento\Catalog\Model\View\Asset\ImageFactory as AssetImageFactory;
+use Magento\Catalog\Model\Product;
+use Magento\Catalog\Model\Product\Image\ParamsBuilder;
+use Magento\Catalog\Model\View\Asset\PlaceholderFactory;
+use Magento\Framework\ObjectManagerInterface;
+use Magento\Framework\View\ConfigInterface;
+use Magento\Catalog\Helper\Image as ImageHelper;
+use WeltPixel\CategoryPage\Helper\Data as CategoryPageHelper;
+use WeltPixel\OwlCarouselSlider\Helper\Custom as OwlHelperCustom;
+use Icube\LazyLoading\Helper\Data as LazyLoadingHelper;
+
+
+/**
+ * Create imageBlock from product and view.xml
+ */
+class ImageFactory extends \Magento\Catalog\Block\Product\ImageFactory
+{
+    /**
+     * @var ConfigInterface
+     */
+    private $presentationConfig;
+
+    /**
+     * @var AssetImageFactory
+     */
+    private $viewAssetImageFactory;
+
+    /**
+     * @var ParamsBuilder
+     */
+    private $imageParamsBuilder;
+
+    /**
+     * @var ObjectManagerInterface
+     */
+    private $objectManager;
+
+    /**
+     * @var PlaceholderFactory
+     */
+    private $viewAssetPlaceholderFactory;
+
+    /** @var  CategoryPageHelper */
+    private $categoryPageHelper;
+
+    /**
+     * @var OwlHelperCustom
+     */
+    private $owlHelperCustom;
+
+    /**
+     * @var LazyLoadingHelper
+     */
+    private $lazyLoadingHelper;
+
+    /**
+     * @param ObjectManagerInterface $objectManager
+     * @param ConfigInterface $presentationConfig
+     * @param AssetImageFactory $viewAssetImageFactory
+     * @param PlaceholderFactory $viewAssetPlaceholderFactory
+     * @param ParamsBuilder $imageParamsBuilder
+     * @param CategoryPageHelper $categoryPageHelper
+     * @param OwlHelperCustom $owlHelperCustom
+     * @param LazyLoadingHelper $lazyLoadingHelper
+     */
+    public function __construct(
+        ObjectManagerInterface $objectManager,
+        ConfigInterface $presentationConfig,
+        AssetImageFactory $viewAssetImageFactory,
+        PlaceholderFactory $viewAssetPlaceholderFactory,
+        ParamsBuilder $imageParamsBuilder,
+        CategoryPageHelper $categoryPageHelper,
+        OwlHelperCustom $owlHelperCustom,
+        LazyLoadingHelper $lazyLoadingHelper
+    ) {
+        $this->objectManager = $objectManager;
+        $this->presentationConfig = $presentationConfig;
+        $this->viewAssetPlaceholderFactory = $viewAssetPlaceholderFactory;
+        $this->viewAssetImageFactory = $viewAssetImageFactory;
+        $this->imageParamsBuilder = $imageParamsBuilder;
+        $this->categoryPageHelper = $categoryPageHelper;
+        $this->owlHelperCustom = $owlHelperCustom;
+        $this->lazyLoadingHelper = $lazyLoadingHelper;
+    }
+
+    /**
+     * Retrieve image custom attributes for HTML element
+     *
+     * @param array $attributes
+     * @return string
+     */
+    private function getStringCustomAttributes(array $attributes): string
+    {
+        $result = [];
+        foreach ($attributes as $name => $value) {
+            if (in_array($name, ['weltpixel_lazyLoad', 'weltpixel_owlcarousel'])) continue;
+            $result[] = $name . '="' . $value . '"';
+        }
+        return !empty($result) ? implode(' ', $result) : '';
+    }
+
+    /**
+     * Retrieve image class for HTML element
+     *
+     * @param array $attributes
+     * @return string
+     */
+    private function getClass(array $attributes): string
+    {
+        return $attributes['class'] ?? 'product-image-photo';
+    }
+
+    /**
+     * Calculate image ratio
+     *
+     * @param int $width
+     * @param int $height
+     * @return float
+     */
+    private function getRatio(int $width, int $height): float
+    {
+        if ($width && $height) {
+            return $height / $width;
+        }
+        return 1.0;
+    }
+
+    /**
+     * Get image label
+     *
+     * @param Product $product
+     * @param string $imageType
+     * @return string
+     */
+    private function getLabel(Product $product, string $imageType): string
+    {
+        $label = $product->getData($imageType . '_' . 'label');
+        if (empty($label)) {
+            $label = $product->getName();
+        }
+        return (string) $label;
+    }
+
+    /**
+     * @param array $attributes
+     * @return bool
+     */
+    private function isLazyLoadEnabled(array $attributes): bool
+    {
+        foreach ($attributes as $name => $value) {
+            if ($name == 'weltpixel_lazyLoad') {
+                return true;
+            }
+        }
+
+        return false;
+    }
+
+    /**
+     * @param array $attributes
+     * @return bool
+     */
+    private function isOwlCarouselEnabled(array $attributes): bool
+    {
+        foreach ($attributes as $name => $value) {
+            if ($name == 'weltpixel_owlcarousel') {
+                return true;
+            }
+        }
+
+        return false;
+    }
+
+    /**
+     * Create image block from product
+     *
+     * @param Product $product
+     * @param string $imageId
+     * @param array|null $attributes
+     * @return ImageBlock
+     */
+    public function create(Product $product, string $imageId, array $attributes = null): ImageBlock
+    {
+        $viewImageConfig = $this->presentationConfig->getViewConfig()->getMediaAttributes(
+            'Magento_Catalog',
+            ImageHelper::MEDIA_TYPE_CONFIG_NODE,
+            $imageId
+        );
+
+        $imageMiscParams = $this->imageParamsBuilder->build($viewImageConfig);
+        $originalFilePath = $product->getData($imageMiscParams['image_type']);
+
+        if ($originalFilePath === null || $originalFilePath === 'no_selection') {
+            $imageAsset = $this->viewAssetPlaceholderFactory->create(
+                [
+                    'type' => $imageMiscParams['image_type']
+                ]
+            );
+        } else {
+            $imageAsset = $this->viewAssetImageFactory->create(
+                [
+                    'miscParams' => $imageMiscParams,
+                    'filePath' => $originalFilePath,
+                ]
+            );
+        }
+
+        $ratioWidth = $imageMiscParams['image_width'] ? intval($imageMiscParams['image_width']) : 0;
+        $ratioHeight = $imageMiscParams['image_height'] ? intval($imageMiscParams['image_height']) : 0;
+
+        $data = [
+            'data' => [
+                'template' => 'Magento_Catalog::product/image_with_borders.phtml',
+                'image_url' => $imageAsset->getUrl(),
+                'width' => $imageMiscParams['image_width'],
+                'height' => $imageMiscParams['image_height'],
+                'label' => $this->getLabel($product, $imageMiscParams['image_type']),
+                'ratio' => $this->getRatio($ratioWidth, $ratioHeight),
+                'custom_attributes' => $this->getStringCustomAttributes($attributes),
+                'class' => $this->getClass($attributes),
+                'product_id' => $product->getId()
+            ],
+        ];
+
+        $hoverImageIds = [];
+
+        /** Check if owlcarousel's hover is enabled */
+        if ($this->owlHelperCustom->isHoverImageEnabled()) {
+            $hoverImageIds[] = 'related_products_list';
+            $hoverImageIds[] = 'upsell_products_list';
+            $hoverImageIds[] = 'cart_cross_sell_products';
+            $hoverImageIds[] = 'new_products_content_widget_grid';
+        }
+
+        /** Check if product listing hover is enabled */
+        if ($this->categoryPageHelper->isHoverImageEnabled()) {
+            $hoverImageIds[] = 'category_page_grid';
+            $hoverImageIds[] = 'category_page_list';
+        }
+
+        if (empty($hoverImageIds) && !$this->isLazyLoadEnabled($attributes) && !$this->lazyLoadingHelper->isEnabled()) {
+            return $this->objectManager->create(ImageBlock::class, $data);
+        }
+
+        $data['data']['template'] = 'Icube_LazyLoading::product/image_with_borders.phtml';
+
+        if (in_array($imageId, $hoverImageIds)) {
+
+            $hoverViewImageConfig = $this->presentationConfig->getViewConfig()->getMediaAttributes(
+                'Magento_Catalog',
+                ImageHelper::MEDIA_TYPE_CONFIG_NODE,
+                $imageId . '_hover'
+            );
+
+            $hoverImageMiscParams = $this->imageParamsBuilder->build($hoverViewImageConfig);
+            $hoverOriginalFilePath = $product->getData($hoverImageMiscParams['image_type']);
+            $hoverPlaceHolderUsed = false;
+
+            if ($hoverOriginalFilePath === null || $hoverOriginalFilePath === 'no_selection') {
+                $hoverImageAsset = $this->viewAssetPlaceholderFactory->create(
+                    [
+                        'type' => $hoverImageMiscParams['image_type']
+                    ]
+                );
+                $hoverPlaceHolderUsed = true;
+            } else {
+                $hoverImageAsset = $this->viewAssetImageFactory->create(
+                    [
+                        'miscParams' => $hoverImageMiscParams,
+                        'filePath' => $hoverOriginalFilePath,
+                    ]
+                );
+            }
+
+            /** Do not display hover placeholder */
+            if ($hoverPlaceHolderUsed) {
+                $data['data']['hover_image_url'] = NULL;
+            } else {
+                $data['data']['hover_image_url'] = $hoverImageAsset->getUrl();
+            }
+        }
+
+        if ($this->isLazyLoadEnabled($attributes)) {
+            $data['data']['lazy_load'] = true;
+        }
+        if ($this->isOwlCarouselEnabled($attributes)) {
+            $data['data']['owlcarousel'] = true;
+        }
+
+        return $this->objectManager->create(ImageBlock::class, $data);
+    }
+}
diff --git a/app/code/Icube/LazyLoading/Helper/Data.php b/app/code/Icube/LazyLoading/Helper/Data.php
new file mode 100644
index 000000000..a09e3a1ea
--- /dev/null
+++ b/app/code/Icube/LazyLoading/Helper/Data.php
@@ -0,0 +1,71 @@
+<?php
+
+namespace Icube\LazyLoading\Helper;
+
+class Data extends \WeltPixel\LazyLoading\Helper\Data
+{
+    public function getImageLoader()
+    {
+        $ImgLoader = $this->_assetRepo->getUrlWithParams('WeltPixel_LazyLoading::images/Loader.gif', []);
+        $customImgLoader = $this->getIconUrl();
+        if (!empty($customImgLoader)) {
+            return $customImgLoader;
+        }
+
+        return $ImgLoader;
+    }
+
+    public function getSmallImageLoader($productId, $imageId, $width, $height)
+    {
+        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
+        $product = $objectManager->create('Magento\Catalog\Model\Product')->load($productId);
+
+        $smallImageUrl = $this->_assetRepo->getUrlWithParams('WeltPixel_LazyLoading::images/Loader.gif', []);
+        if ($product) {
+            $imageHelper  = $objectManager->get('Magento\Catalog\Helper\Image');
+            $smallImageUrl = $imageHelper
+                                ->init($product, $imageId)
+                                ->constrainOnly(TRUE)
+                                ->keepAspectRatio(TRUE)
+                                ->keepTransparency(TRUE)
+                                ->keepFrame(FALSE)
+                                ->resize($width, $height);
+        }
+
+        return $smallImageUrl;
+    }
+
+    public function getImageLoaderIsSet()
+    {
+        if ($this->getLoadingPlaceholder()) {
+            $customImgLoader = $this->getIconUrl();
+            if (!empty($customImgLoader)) {
+                return true;
+            }
+        }
+
+        return false;
+    }
+
+    private function getIconUrl($storeId = 0)
+    {
+        $image = $this->getLoadingIcon($storeId);
+        if ($image) {
+            $imagePath = 'weltpixel/lazyloading/logo/' . $image;
+            $imageUrl = $this->_currentStore->getBaseUrl(\Magento\Framework\UrlInterface::URL_TYPE_MEDIA);
+
+            return $imageUrl . $imagePath;
+        }
+
+        return '';
+    }
+
+    private function getLoadingIcon($storeId = 0)
+    {
+        if ($storeId) {
+            return $this->scopeConfig->getValue('weltpixel_lazy_loading/advanced/loading_icon', \Magento\Store\Model\ScopeInterface::SCOPE_STORE, $storeId);
+        } else {
+            return $this->_lazyLoadOptions['advanced']['loading_icon'];
+        }
+    }
+}
\ No newline at end of file
diff --git a/app/code/Icube/LazyLoading/etc/frontend/di.xml b/app/code/Icube/LazyLoading/etc/frontend/di.xml
new file mode 100644
index 000000000..929b1c073
--- /dev/null
+++ b/app/code/Icube/LazyLoading/etc/frontend/di.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
+    <preference for="Magento\Catalog\Block\Product\ImageFactory" type="Icube\LazyLoading\Block\Product\ImageFactory" />
+    <preference for="WeltPixel\LazyLoading\Helper\Data" type="Icube\LazyLoading\Helper\Data" />
+</config>
\ No newline at end of file
diff --git a/app/code/Icube/LazyLoading/etc/module.xml b/app/code/Icube/LazyLoading/etc/module.xml
new file mode 100644
index 000000000..980bdaad7
--- /dev/null
+++ b/app/code/Icube/LazyLoading/etc/module.xml
@@ -0,0 +1,15 @@
+<?xml version="1.0"?>
+<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:Module/etc/module.xsd">
+    <module name="Icube_LazyLoading" setup_version="1.0.0" >
+        <sequence>
+            <module name="WeltPixel_Backend"/>
+            <module name="WeltPixel_FrontendOptions"/>
+            <module name="Magento_Catalog"/>
+            <module name="Magento_CatalogSearch"/>
+            <module name="Magento_Swatches" />
+            <module name="WeltPixel_OwlCarouselSlider" />
+            <module name="WeltPixel_Lazyloading" />
+            <module name="WeltPixel_CategoryPage" />
+        </sequence>
+    </module>
+</config>
diff --git a/app/code/Icube/LazyLoading/registration.php b/app/code/Icube/LazyLoading/registration.php
new file mode 100644
index 000000000..4c7593227
--- /dev/null
+++ b/app/code/Icube/LazyLoading/registration.php
@@ -0,0 +1,7 @@
+<?php
+
+\Magento\Framework\Component\ComponentRegistrar::register(
+    \Magento\Framework\Component\ComponentRegistrar::MODULE,
+    'Icube_LazyLoading',
+    __DIR__
+);
\ No newline at end of file
diff --git a/app/code/Icube/LazyLoading/view/frontend/templates/product/image.phtml b/app/code/Icube/LazyLoading/view/frontend/templates/product/image.phtml
new file mode 100644
index 000000000..58b56e58f
--- /dev/null
+++ b/app/code/Icube/LazyLoading/view/frontend/templates/product/image.phtml
@@ -0,0 +1,76 @@
+<?php /** @var $block \Magento\Catalog\Block\Product\Image */ ?>
+<?php $lazyLoadHelper = $this->helper('Icube\LazyLoading\Helper\Data');
+$pWidth = $lazyLoadHelper->getPlaceholderWidth() ?? '100%';
+$isRequestAjax = $lazyLoadHelper->isRequestAjax();
+$isImageLoaderSet = $lazyLoadHelper->getImageLoaderIsSet();
+$lazyLodImgSrc = $lazyLoadHelper->getImageLoader();
+if (!$isImageLoaderSet) {
+    $imageId = 'product_small_image';
+    $width = 10;
+    $height = 10;
+    $lazyLodImgSrc = $lazyLoadHelper->getSmallImageLoader($block->getProductId(), $imageId, $width, $height)->getUrl();
+}
+$lazyLoadImgDataOriginal = $block->getImageUrl();
+if ($isRequestAjax) {
+    $pWidth = '100%';
+    $lazyLodImgSrc = $lazyLoadImgDataOriginal;
+}
+$negativeMargin = $lazyLoadHelper->startLoadingEarly() ? $lazyLoadHelper->getNegativeMargin() : 0;
+$effectSpeed = $lazyLoadHelper->startLoadingEarly() ? $lazyLoadHelper->getEffectSpeed() : 0;
+?>
+
+<?php
+$lazyLoadClass = '';
+if ($block->getLazyLoad()) {
+    $pWidth = '100%';
+    $lazyLoadClass = 'owl-lazy';
+} elseif ($lazyLoadHelper->startLoadingPlaceholder() && !$block->getOwlcarousel() ) {
+    $lazyLoadClass = 'lazy';
+}
+?>
+
+<img class="photo image <?php echo $lazyLoadClass; ?>"
+    <?php /* @escapeNotVerified */ echo $block->getCustomAttributes(); ?>
+    <?php if (!$block->getLazyLoad()): ?>
+        <?php if ($lazyLoadHelper->startLoadingPlaceholder() && !$block->getOwlcarousel()) : ?>
+            src="<?php /* @escapeNotVerified */ echo $lazyLodImgSrc; ?>"
+            data-original="<?php /* @escapeNotVerified */ echo $lazyLoadImgDataOriginal; ?>"
+            <?php if ($isImageLoaderSet) :  ?>
+                style="max-width:<?php echo $pWidth ?>"
+            <?php endif; ?>
+        <?php else:  ?>
+            src="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+        <?php endif; ?>
+    <?php endif; ?>
+    <?php if ($block->getHoverImageUrl()) :  ?>
+        data-hoversrc="<?php /* @escapeNotVerified */ echo $block->getHoverImageUrl(); ?>"
+        data-origsrc="<?php /* @escapeNotVerified */ echo $lazyLoadImgDataOriginal; ?>"
+        onmouseover="this.setAttribute('data-tmp', this.src);this.src=this.getAttribute('data-hoversrc');"
+        onmouseout="this.src=this.getAttribute('data-tmp')"
+        onmousemove="if (this.getAttribute('data-hoversrc') != this.src) this.setAttribute('data-tmp', this.src)"
+    <?php endif; ?>
+     width="<?php /* @escapeNotVerified */ echo $block->getWidth(); ?>"
+     height="<?php /* @escapeNotVerified */ echo $block->getHeight(); ?>"
+     alt="<?php /* @escapeNotVerified */ echo $block->stripTags($block->getLabel(), null, true); ?>"
+    <?php if ($block->getLazyLoad()): ?>
+         data-src="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+         data-src-retina="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+         <?php if ($isImageLoaderSet) :  ?>
+            style="max-width:<?php echo $pWidth ?>"
+         <?php endif; ?>
+    <?php endif; ?>
+/>
+
+<script type="text/javascript">
+    require(['jquery', 'WeltPixel_LazyLoading/js/jquery_lazyload'], function($) {
+        $("img.lazy").lazyload({
+            effect: "fadeIn",
+            effectspeed: <?php echo $effectSpeed ?>,
+            imageloader: "<?php echo $lazyLodImgSrc ?>",
+            threshold: "<?php echo $negativeMargin ?>",
+            load: function(elements_left, settings) {
+                $(this).css({'max-width':'100%'});
+            }
+        });
+    });
+</script>
diff --git a/app/code/Icube/LazyLoading/view/frontend/templates/product/image_with_borders.phtml b/app/code/Icube/LazyLoading/view/frontend/templates/product/image_with_borders.phtml
new file mode 100644
index 000000000..a3316262a
--- /dev/null
+++ b/app/code/Icube/LazyLoading/view/frontend/templates/product/image_with_borders.phtml
@@ -0,0 +1,81 @@
+<?php /** @var $block \Magento\Catalog\Block\Product\Image */ ?>
+<?php $lazyLoadHelper = $this->helper('Icube\LazyLoading\Helper\Data');
+$pWidth = $lazyLoadHelper->getPlaceholderWidth() ?? '100%';
+$isRequestAjax = $lazyLoadHelper->isRequestAjax();
+$isImageLoaderSet = $lazyLoadHelper->getImageLoaderIsSet();
+$lazyLodImgSrc = $lazyLoadHelper->getImageLoader();
+if (!$isImageLoaderSet) {
+    $imageId = 'product_small_image';
+    $width = 10;
+    $height = 10;
+    $lazyLodImgSrc = $lazyLoadHelper->getSmallImageLoader($block->getProductId(), $imageId, $width, $height)->getUrl();
+}
+$lazyLoadImgDataOriginal = $block->getImageUrl();
+if ($isRequestAjax) {
+    $pWidth = '100%';
+    $lazyLodImgSrc = $lazyLoadImgDataOriginal;
+}
+$negativeMargin = $lazyLoadHelper->startLoadingEarly() ? $lazyLoadHelper->getNegativeMargin() : 0;
+$effectSpeed = $lazyLoadHelper->startLoadingEarly() ? $lazyLoadHelper->getEffectSpeed() : 0;
+?>
+
+<?php
+$lazyLoadClass = '';
+if ($block->getLazyLoad()) {
+    $pWidth = '100%';
+    $lazyLoadClass = 'owl-lazy';
+} elseif ($lazyLoadHelper->startLoadingPlaceholder() && !$block->getOwlcarousel()) {
+    $lazyLoadClass = 'lazy';
+}
+?>
+
+<span class="product-image-container"
+      style="width:<?php /* @escapeNotVerified */ echo $block->getWidth()?>px;">
+    <span class="product-image-wrapper"
+          style="padding-bottom: <?php /* @escapeNotVerified */ echo ($block->getRatio() * 100); ?>%;">
+        <img class="<?= /* @escapeNotVerified */ $block->getClass() ?> <?php echo $lazyLoadClass; ?>"
+            <?php /* @escapeNotVerified */ echo $block->getCustomAttributes(); ?>
+            <?php if (!$block->getLazyLoad()): ?>
+                <?php if ($lazyLoadHelper->startLoadingPlaceholder()  && !$block->getOwlcarousel() ) : ?>
+                    src="<?php /* @escapeNotVerified */ echo $lazyLodImgSrc; ?>"
+                    data-original="<?php /* @escapeNotVerified */ echo $lazyLoadImgDataOriginal; ?>"
+                    <?php if ($isImageLoaderSet) :  ?>
+                        style="max-width:<?php echo $pWidth ?>"
+                    <?php endif; ?>
+                <?php else:  ?>
+                    src="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+                <?php endif; ?>
+            <?php endif ;?>
+            <?php if ($block->getHoverImageUrl()) :  ?>
+                data-hoversrc="<?php /* @escapeNotVerified */ echo $block->getHoverImageUrl(); ?>"
+                data-origsrc="<?php /* @escapeNotVerified */ echo $lazyLoadImgDataOriginal; ?>"
+                onmouseover="this.setAttribute('data-tmp', this.src);this.src=this.getAttribute('data-hoversrc');"
+                onmouseout="this.src=this.getAttribute('data-tmp')"
+                onmousemove="if (this.getAttribute('data-hoversrc') != this.src) this.setAttribute('data-tmp', this.src)"
+            <?php endif; ?>
+             width="<?php /* @escapeNotVerified */ echo $block->getWidth(); ?>"
+             height="<?php /* @escapeNotVerified */ echo $block->getHeight(); ?>"
+             alt="<?php /* @escapeNotVerified */ echo $block->stripTags($block->getLabel(), null, true); ?>"
+            <?php if ($block->getLazyLoad()): ?>
+                data-src="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+                data-src-retina="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+                <?php if ($isImageLoaderSet) :  ?>
+                    style="max-width:<?php echo $pWidth ?>"
+                <?php endif; ?>
+            <?php endif; ?>
+        /></span>
+</span>
+
+<script type="text/javascript">
+    require(['jquery', 'WeltPixel_LazyLoading/js/jquery_lazyload'], function($) {
+        $("img.lazy").lazyload({
+            effect: "fadeIn",
+            effectspeed: <?php echo $effectSpeed ?>,
+            imageloader: "<?php echo $lazyLodImgSrc ?>",
+            threshold: "<?php echo $negativeMargin ?>",
+            load: function(elements_left, settings) {
+                $(this).css({'max-width':'100%'});
+            }
+        });
+    });
+</script>
diff --git a/app/code/Icube/LazyLoadingWebp/Block/Product/Image.php b/app/code/Icube/LazyLoadingWebp/Block/Product/Image.php
new file mode 100644
index 000000000..c5a71835f
--- /dev/null
+++ b/app/code/Icube/LazyLoadingWebp/Block/Product/Image.php
@@ -0,0 +1,46 @@
+<?php
+
+namespace Icube\LazyLoadingWebp\Block\Product;
+
+class Image extends \Magento\Catalog\Block\Product\Image
+{
+    public function __construct(
+        \Magento\Framework\View\Element\Template\Context $context,
+        \Jajuma\WebpImages\Helper\Data $helper,
+        array $data = []
+    ) {
+        $this->helper = $helper;
+        $data['template']='Icube_LazyLoadingWebp::category/lazyload_custom.phtml';
+        if (isset($data['template'])) {
+            $this->setTemplate($data['template']);
+            unset($data['template']);
+        }
+        parent::__construct($context, $data);
+    }
+
+    public function getImageUrl()
+    {
+        $imageUrl = parent::getImageUrl();
+
+        if ($imageUrl != '') {
+            return $this->helper->convert($imageUrl);
+        } else {
+            return $imageUrl;
+        }
+    }
+
+    public function getHoverImageUrl()
+    {
+        $hoverImageUrl = parent::getHoverImageUrl();
+        if ($hoverImageUrl != '') {
+            return $this->helper->convert($hoverImageUrl);
+        } else {
+            return $hoverImageUrl;
+        }
+    }
+
+    public function getOrigImageUrl()
+    {
+        return parent::getImageUrl();
+    }
+}
diff --git a/app/code/Icube/LazyLoadingWebp/etc/frontend/di.xml b/app/code/Icube/LazyLoadingWebp/etc/frontend/di.xml
new file mode 100644
index 000000000..eaba36899
--- /dev/null
+++ b/app/code/Icube/LazyLoadingWebp/etc/frontend/di.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
+    <preference for="Jajuma\WebpImages\Block\Product\Image" type="Icube\LazyLoadingWebp\Block\Product\Image" />
+</config>
\ No newline at end of file
diff --git a/app/code/Icube/LazyLoadingWebp/etc/module.xml b/app/code/Icube/LazyLoadingWebp/etc/module.xml
new file mode 100644
index 000000000..c84766af2
--- /dev/null
+++ b/app/code/Icube/LazyLoadingWebp/etc/module.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" ?>
+<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:Module/etc/module.xsd">
+    <module name="Icube_LazyLoadingWebp" setup_version="1.0.0">
+    	<sequence>
+		    <module name="Magento_ConfigurableProduct" />
+		</sequence>
+    </module>
+</config>
diff --git a/app/code/Icube/LazyLoadingWebp/registration.php b/app/code/Icube/LazyLoadingWebp/registration.php
new file mode 100644
index 000000000..454cdff18
--- /dev/null
+++ b/app/code/Icube/LazyLoadingWebp/registration.php
@@ -0,0 +1,7 @@
+<?php
+
+\Magento\Framework\Component\ComponentRegistrar::register(
+    \Magento\Framework\Component\ComponentRegistrar::MODULE,
+    'Icube_LazyLoadingWebp',
+    __DIR__
+);
\ No newline at end of file
diff --git a/app/code/Icube/LazyLoadingWebp/view/frontend/templates/category/lazyload_custom.phtml b/app/code/Icube/LazyLoadingWebp/view/frontend/templates/category/lazyload_custom.phtml
new file mode 100644
index 000000000..f1a7f4e66
--- /dev/null
+++ b/app/code/Icube/LazyLoadingWebp/view/frontend/templates/category/lazyload_custom.phtml
@@ -0,0 +1,93 @@
+<?php /** @var $block \Jajuma\WebpImages\Block\Product\Image */ ?>
+<?php 
+    $imageUrl = $block->getImageUrl();
+?>
+
+<?php $lazyLoadHelper = $this->helper('Icube\LazyLoading\Helper\Data');
+$pWidth = $lazyLoadHelper->getPlaceholderWidth() ?? '100%';
+$isRequestAjax = $lazyLoadHelper->isRequestAjax();
+$isImageLoaderSet = $lazyLoadHelper->getImageLoaderIsSet();
+$lazyLodImgSrc = $lazyLoadHelper->getImageLoader();
+if (!$isImageLoaderSet) {
+    $imageId = 'product_small_image';
+    $width = 10;
+    $height = 10;
+    $lazyLodImgSrc = $lazyLoadHelper->getSmallImageLoader($block->getProductId(), $imageId, $width, $height)->getUrl();
+}
+$lazyLoadImgDataOriginal = $block->getImageUrl();
+if ($isRequestAjax) {
+    $pWidth = '100%';
+    $lazyLodImgSrc = $lazyLoadImgDataOriginal;
+}
+$negativeMargin = $lazyLoadHelper->startLoadingEarly() ? $lazyLoadHelper->getNegativeMargin() : 0;
+$effectSpeed = $lazyLoadHelper->startLoadingEarly() ? $lazyLoadHelper->getEffectSpeed() : 0;
+?>
+
+<?php
+$lazyLoadClass = '';
+if ($block->getLazyLoad()) {
+    $pWidth = '100%';
+    $lazyLoadClass = 'owl-lazy';
+} elseif ($lazyLoadHelper->startLoadingPlaceholder() && !$block->getOwlcarousel() ) {
+    $lazyLoadClass = 'lazy';
+}
+?>
+
+<span class="product-image-container"
+      style="width:<?= $block->escapeHtmlAttr($block->getWidth()) ?>px;">
+    <span class="product-image-wrapper" style="padding-bottom: <?= ($block->getRatio() * 100) ?>%;">
+
+    <picture>
+        <source type="image/webp" src="<?= $imageUrl ?>">
+        <source type="image/png" src="<?= $block->getOrigImageUrl() ?>">
+        <img class="<?= /* @escapeNotVerified */ $block->getClass() ?> <?php echo $lazyLoadClass; ?>"
+            <?php /* @escapeNotVerified */ echo $block->getCustomAttributes(); ?>
+            <?php if (!$block->getLazyLoad()): ?>
+                <?php if ($lazyLoadHelper->startLoadingPlaceholder()  && !$block->getOwlcarousel() ) : ?>
+                    src="<?php /* @escapeNotVerified */ echo $lazyLodImgSrc; ?>"
+                    data-original="<?php /* @escapeNotVerified */ echo $lazyLoadImgDataOriginal; ?>"
+                    <?php if ($isImageLoaderSet) :  ?>
+                        style="max-width:<?php echo $pWidth ?>"
+                    <?php endif; ?>
+                <?php else:  ?>
+                    src="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+                <?php endif; ?>
+            <?php endif ;?>
+            <?php if ($block->getHoverImageUrl()) :  ?>
+                data-hoversrc="<?php /* @escapeNotVerified */ echo $block->getHoverImageUrl(); ?>"
+                data-origsrc="<?php /* @escapeNotVerified */ echo $lazyLoadImgDataOriginal; ?>"
+                onmouseover="this.setAttribute('data-tmp', this.src);this.src=this.getAttribute('data-hoversrc');"
+                onmouseout="this.src=this.getAttribute('data-tmp')"
+                onmousemove="if (this.getAttribute('data-hoversrc') != this.src) this.setAttribute('data-tmp', this.src)"
+            <?php endif; ?>
+             width="<?php /* @escapeNotVerified */ echo $block->getWidth(); ?>"
+             height="<?php /* @escapeNotVerified */ echo $block->getHeight(); ?>"
+             alt="<?php /* @escapeNotVerified */ echo $block->stripTags($block->getLabel(), null, true); ?>"
+            <?php if ($block->getLazyLoad()): ?>
+                data-src="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+                data-src-retina="<?php /* @escapeNotVerified */ echo $block->getImageUrl(); ?>"
+                <?php if ($isImageLoaderSet) :  ?>
+                    style="max-width:<?php echo $pWidth ?>"
+                <?php endif; ?>
+            <?php endif; ?>
+        />
+    </picture>
+
+
+    </span>
+</span>
+
+<script type="text/javascript">
+    require(['jquery', 'WeltPixel_LazyLoading/js/jquery_lazyload'], function($) {
+        $("img.lazy").lazyload({
+            effect: "fadeIn",
+            effectspeed: <?php echo $effectSpeed ?>,
+            imageloader: "<?php echo $lazyLodImgSrc ?>",
+            threshold: "<?php echo $negativeMargin ?>",
+            load: function(elements_left, settings) {
+                $(this).css({'max-width':'100%'});
+                console.log("<?php echo $lazyLodImgSrc ?>")
+            }
+        });
+    });
+</script>
\ No newline at end of file
-- 
2.20.1

