From 9dc2df6acd081957e3132252db778e8d0e9a514b Mon Sep 17 00:00:00 2001
From: hanifrizalpratama <hanif@icube.us>
Date: Mon, 9 Nov 2020 00:14:17 +0000
Subject: [PATCH] patch for import category image 2.4.1

---
 .../Category/Attribute/Backend/Image.php      | 30 ++-----------------
 1 file changed, 2 insertions(+), 28 deletions(-)

diff --git a/vendor/magento/module-catalog/Model/Category/Attribute/Backend/Image.php b/vendor/magento/module-catalog/Model/Category/Attribute/Backend/Image.php
index 865160da1..fe8ad435e 100644
--- a/vendor/magento/module-catalog/Model/Category/Attribute/Backend/Image.php
+++ b/vendor/magento/module-catalog/Model/Category/Attribute/Backend/Image.php
@@ -103,25 +103,6 @@ class Image extends \Magento\Eav\Model\Entity\Attribute\Backend\AbstractBackend
         return '';
     }
 
-    /**
-     * Check that image name exists in catalog/category directory and return new image name if it already exists.
-     *
-     * @param string $imageName
-     * @return string
-     */
-    private function checkUniqueImageName(string $imageName): string
-    {
-        $mediaDirectory = $this->_filesystem->getDirectoryWrite(DirectoryList::MEDIA);
-        $imageAbsolutePath = $mediaDirectory->getAbsolutePath(
-            $this->imageUploader->getBasePath() . DIRECTORY_SEPARATOR . $imageName
-        );
-
-        // phpcs:ignore Magento2.Functions.DiscouragedFunction
-        $imageName = call_user_func([Uploader::class, 'getNewFilename'], $imageAbsolutePath);
-
-        return $imageName;
-    }
-
     /**
      * Avoiding saving potential upload data to DB.
      *
@@ -149,15 +130,10 @@ class Image extends \Magento\Eav\Model\Entity\Attribute\Backend\AbstractBackend
             }
         } elseif ($this->fileResidesOutsideCategoryDir($value)) {
             // use relative path for image attribute so we know it's outside of category dir when we fetch it
-            // phpcs:ignore Magento2.Functions.DiscouragedFunction
-            $value[0]['url'] = parse_url($value[0]['url'], PHP_URL_PATH);
             $value[0]['name'] = $value[0]['url'];
         }
 
         if ($imageName = $this->getUploadedImageName($value)) {
-            if (!$this->fileResidesOutsideCategoryDir($value)) {
-                $imageName = $this->checkUniqueImageName($imageName);
-            }
             $object->setData($this->additionalData . $attributeName, $value);
             $object->setData($attributeName, $imageName);
         } elseif (!is_string($value)) {
@@ -193,11 +169,9 @@ class Image extends \Magento\Eav\Model\Entity\Attribute\Backend\AbstractBackend
         $fileUrl = ltrim($value[0]['url'], '/');
         $baseMediaDir = $this->_filesystem->getUri(DirectoryList::MEDIA);
 
-        if (!$baseMediaDir) {
-            return false;
-        }
+        $usingPathRelativeToBase = strpos($fileUrl, $baseMediaDir) === 0;
 
-        return strpos($fileUrl, $baseMediaDir) !== false;
+        return $usingPathRelativeToBase;
     }
 
     /**
-- 
2.20.1

